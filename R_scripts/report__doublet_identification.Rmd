---
title: "doublet analysis"
output: md_document
date: '2022-08-09'
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(sccomp)
library(ggrepel)
library(Seurat)
library(glue)
library(scDblFinder)
library(tidyseurat)
library(tidySingleCellExperiment)
```


```{r, warning=FALSE, message=FALSE,echo=FALSE, results='hide'}
## The following output is from scDblFinder
#take the output files, which include 3_prime_batch/preprocessing_output/non_batch_variation_removal
files <- dir("/stornext/Bioinf/data/bioinf-data/Papenfuss_lab/projects/mangiola.s/PostDoc/covid19pbmc/data/all_batches/preprocessing_results/non_batch_variation_removal/", full.name = T)
files_annotation <- dir("/stornext/Bioinf/data/bioinf-data/Papenfuss_lab/projects/mangiola.s/PostDoc/covid19pbmc/data/all_batches/preprocessing_results/annotation_label_transfer/", full.name = T)
files_doublets <- dir("/stornext/Bioinf/data/bioinf-data/Papenfuss_lab/projects/mangiola.s/PostDoc/covid19pbmc/data/all_batches/preprocessing_results/doublet_identification/", full.name = T)

metadata_file = "/stornext/Bioinf/data/bioinf-data/Papenfuss_lab/projects/mangiola.s/PostDoc/covid19pbmc/data/all_batches/metadata.rds"

files = files |> head(2)
files_annotation = files_annotation |> head(2)
files_doublets = files_doublets |> head(2)


files |> 
  enframe(value = "file") |> 
  extract(file, "sample", ".+/([0-9a-zA-Z]+)__non_batch_variation_removal_output.rds", remove = FALSE) |> 
  left_join(readRDS(metadata_file)) |> 
  nest(files_df = -batch) |> 
  mutate(data = map(
    files_df,
    ~ 
  ))
```


```{r, warning=FALSE, message=FALSE,echo=FALSE}
#combine count dataframe by rows using seurat function merge
merged_combined <- 
  files |>
  map(readRDS) |>
  purrr::reduce(merge)

#have a look at the output generated by scDblFinder:
merged_combined_annotation_doublets <-
  
  #join annotation
  merged_combined |>
  left_join(
    files_annotation |>
      map(readRDS) |>
      purrr::reduce(bind_rows), by=".cell") |>
  
  #join doublets identified
  left_join(
    files_doublets |>
      map(readRDS) |>
      purrr::reduce(bind_rows), by = c(".cell"))

```


```{r,warning=FALSE, message=FALSE,echo=FALSE }
get_labels_clusters = function(.data, label_column, dim1, dim2){
    
    tidy_dist = function(x1, x2, y1, y2){
        
        tibble(x1, x2, y1, y2) %>%
            rowwise() %>%
            mutate(dist = matrix(c(x1, x2, y1, y2), nrow = 2, byrow = T) %>% dist()) %>%
            pull(dist)
        
    }
    
    label_column = enquo(label_column)
    dim1 = enquo(dim1)
    dim2 = enquo(dim2)
    
    .data %>%
        nest(data = -!!label_column) %>%
        mutate(
            !!dim1 := map_dbl(data, ~ .x %>% pull(!!dim1) %>% median()),
            !!dim2 := map_dbl(data, ~ .x %>% pull(!!dim2) %>% median())
        ) %>%
        select(-data)
}
```



```{r, fig.width=16, warning=FALSE, message=FALSE,echo=FALSE}
p1 <- merged_combined_annotation_doublets |>
  ggplot(aes(refUMAP_1, refUMAP_2, color = scDblFinder.class)) +
  geom_point(shape=".") +
  theme_bw() +
  
  ggrepel::geom_text_repel(
		data= get_labels_clusters(
			merged_combined_annotation_doublets, 
			scDblFinder.class,
			refUMAP_1, 
			refUMAP_2
		) ,
		aes(refUMAP_1, refUMAP_2, label = scDblFinder.class), size = 2.5
	)


p2 <- merged_combined_annotation_doublets |>
  ggplot(aes(refUMAP_1, refUMAP_2, color = predicted.celltype.l2)) +
  geom_point(shape=".") +
  theme_bw() +
  
  ggrepel::geom_text_repel(
		data= get_labels_clusters(
			merged_combined_annotation_doublets, 
			predicted.celltype.l2,
			refUMAP_1, 
			refUMAP_2
		) ,
		aes(refUMAP_1, refUMAP_2, label = predicted.celltype.l2), size = 2.5
	)

p1 + p2
  
```



```{r, fig.width=16, warning=FALSE, message=FALSE,echo=FALSE}
# 1b) UMAP re-clustering, to do an unsupervised visualization of the clustering of the doublets.
#selecting gene names for features
all.genes <- rownames(merged_combined_annotation_doublets)

#re-clustering
merged_combined_annotation_doublets_reclustered <-
  merged_combined_annotation_doublets |>
  RunPCA(features = all.genes) |>
  FindNeighbors(dims = 1:30) |>
  FindClusters(resolution = 0.5) |>
  RunUMAP(dims = 1:30, spread    = 0.5,min.dist  = 0.01, n.neighbors = 10L)

#plot doublets
p3 <- merged_combined_annotation_doublets_reclustered |>
  ggplot(aes(UMAP_1, UMAP_2, color = scDblFinder.class)) +
  geom_point(shape=".") +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_bw() +
  
  ggrepel::geom_text_repel(
		data= get_labels_clusters(
			merged_combined_annotation_doublets_reclustered, 
			scDblFinder.class,
			UMAP_1, 
			UMAP_2
		) ,
		aes(UMAP_1, UMAP_2, label = scDblFinder.class), size = 2.5
	)
  

#plot cell types
p4 <- merged_combined_annotation_doublets_reclustered |>
  ggplot(aes(UMAP_1, UMAP_2, color = predicted.celltype.l2)) +
  geom_point(shape=".") +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_bw() +
  
  ggrepel::geom_text_repel(
		data= get_labels_clusters(
			merged_combined_annotation_doublets_reclustered, 
			predicted.celltype.l2,
			UMAP_1, 
			UMAP_2
		) ,
		aes(UMAP_1, UMAP_2, label = predicted.celltype.l2), size = 2.5
	)
  

p3 + p4

```


```{r, fig.width=16, warning=FALSE, message=FALSE,echo=FALSE}
# 2a) Create the composition of the doublets

merged_combined_annotation_doublets %>% select(sample, scDblFinder.class) %>% table()

#calculate proportion and plot
plot_composition_proportion_faceted <-
  merged_combined_annotation_doublets |>
  select(sample, nCount_SCT, predicted.celltype.l2, scDblFinder.class) |>
  
  # create frquency column
  mutate(frequency = nCount_SCT/sum(nCount_SCT)*100) |>
  
  # create the proportion column
  group_by(sample, scDblFinder.class) |>
  mutate(tot_sample_proportion = sum(frequency)) |>
  ungroup() |>
  mutate(proportion = (frequency * 1)/tot_sample_proportion) |>
  
  #plot proportion
  ggplot(aes(x = sample, y = proportion, fill = predicted.celltype.l2)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  facet_wrap(~scDblFinder.class) +
  theme(axis.text.x=element_text(angle=70, hjust=1))

#visualise
plot_composition_proportion_faceted

```

```{r,fig.width=16, warning=FALSE, message=FALSE, echo=FALSE}

# 2b) Create the composition of the doublets
merged_combined_annotation_doublets %>% select(sample, scDblFinder.class) %>% table()

#calculate proportion and plot
plot_composition_proportion_faceted_2 <-
  merged_combined_annotation_doublets |>
  select(sample, nCount_SCT, predicted.celltype.l2, scDblFinder.class) |>
  
  # create frquency column
  mutate(frequency = nCount_SCT/sum(nCount_SCT)*100) |>
  
  # create the proportion column
  group_by(sample) |>
  mutate(tot_sample_proportion = sum(frequency)) |>
  ungroup() |>
  mutate(proportion = (frequency * 1)/tot_sample_proportion) |>
  
  #plot proportion
  ggplot(aes(x = sample, y = proportion, fill = predicted.celltype.l2)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  facet_wrap(~scDblFinder.class) +
  theme(axis.text.x=element_text(angle=70, hjust=1))

#visualise
plot_composition_proportion_faceted_2
```
