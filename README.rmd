---
title: "HPCell"
output: github_document
---

<!-- badges: start -->

[![Lifecycle:maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)

<!-- badges: end -->

# HPCell

HPCell is a workflow framework designed for use with single-cell RNA sequencing studies (scRNA-seq), which helps in processing and analyzing the vast amount of data generated by these studies. It is built on the Targets framework within the R programming language, offering an approachable solution for those already proficient in R. The key features of HPCell include:


-   **Native R Pipeline:** HPCell is developed to work natively within the R environment, enhancing usability for R users without requiring them to learn new, workflow-specific languages.

-   **High Performance Computing Support:** HPCell supports scaling for large datasets and enables parallel processing of tasks on High Performance Computing platforms.

-   **Reproducibility and Consistency:** The framework ensures reproducibility and consistent execution environments through automatic dependency generation.

## Install HPCell

```{r, eval=FALSE}

remote::install_github("stemangiola/HPCell")

```


```{r message=FALSE, warning=FALSE}
library(HPCell)
library(tidybulk)
```

## High-performance single-cell, pseudobulk random-effect modelling

The interface is intuitive and consistent with `tidybulk` `test_differential_abundance()`. By default `HPCell` uses `test_differential_abundance(..., method = "glmmSeq_lme4")`

```{r}

# Setup your job submission system
slurm = crew.cluster::crew_controller_slurm(
  name = "slurm",
  slurm_memory_gigabytes_per_cpu = 5,
  slurm_cpus_per_task = 1,
  workers = 200,
  verbose = T
)

# Perform the analyses. 
tidySummarizedExperiment::se |>
  keep_abundant(factor_of_interest = dex) |>
  
  # Spread the workload onto 200 workers and collects the results seamlessly
  test_differential_abundance_hpc(
    ~ dex + (1 | cell)
  )
```

## High-performance single-cell preprocessing

Flowchart

<https://app.mural.co/t/covid7029/m/covid7029/1656652076667/c47e104697d76b36b8dee3bd05d8de9d96d99efd?sender=udbe1ea99c9618abb07196978>

### load input data

```{r message=FALSE, warning=FALSE}
# Load input data (can be a list of directories or single directory)
library(Seurat)
library(scRNAseq)
input_data_path =  tempfile(tmpdir = ".") |> paste0(".rds")
HeOrganAtlasData(ensembl=FALSE,location=FALSE)|>
  as.Seurat(data = NULL) |>
  saveRDS(input_data_path)
```

### Execute Targets workflow and load results

```{r}
# Running the pipeline
preprocessed_seurat = run_targets_pipeline(
    input_data = input_data_path,
    tissue = "pbmc",
    filter_empty_droplets = TRUE,
    sample_column = "Tissue"
)

# Load results
preprocessed_seurat

```

### Include reference dataset for azimuth annotation

Details to come.

```{r, eval=FALSE} 

input_reference_path  <- "reference_azimuth.rds" 
reference_url <- "https://atlas.fredhutch.org/data/nygc/multimodal/pbmc_multimodal.h5seurat" 
download.file(reference_url, input_reference_path) 
LoadH5Seurat(input_reference_path) |> saveRDS(input_reference_path)
```