tidybulk - part of tidyTranscriptomics
================

<!-- badges: start -->

[![Lifecycle:maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)

<!-- badges: end -->

# HPCell

HPCell is a workflow framework designed for use with single-cell RNA
sequencing studies (scRNA-seq), which helps in processing and analyzing
the vast amount of data generated by these studies. It is built on the
Targets framework within the R programming language, offering an
approachable solution for those already proficient in R. The key
features of HPCell include:

- **Native R Pipeline:** HPCell is developed to work natively within the
  R environment, enhancing usability for R users without requiring them
  to learn new, workflow-specific languages.

- **High Performance Computing Support:** HPCell supports scaling for
  large datasets and enables parallel processing of tasks on High
  Performance Computing platforms.

- **Reproducibility and Consistency:** The framework ensures
  reproducibility and consistent execution environments through
  automatic dependency generation.

## Install HPCell

``` r
remote::install_github("stemangiola/HPCell")
```

``` r
library(HPCell)
library(tidybulk)
```

## High-performance single-cell, pseudobulk random-effect modelling

### One datasets/cell-type

The interface is intuitive and consistent with `tidybulk`
`test_differential_abundance()`. By default `HPCell` uses
`test_differential_abundance(..., method = "glmmSeq_lme4")`

``` r
# Setup your job submission system
slurm = crew.cluster::crew_controller_slurm(
  name = "slurm",
  slurm_memory_gigabytes_per_cpu = 5,
  slurm_cpus_per_task = 1,
  workers = 200,
  verbose = T
)

# Perform the analyses. 
tidySummarizedExperiment::se |>
  keep_abundant(factor_of_interest = dex) |>
  
  # Spread the workload onto 200 workers and collects the results seamlessly
  test_differential_abundance_hpc(
    ~ dex + (1 | cell), 
    computing_resources = slurm
  )
```

    ## ‚ñ∂ start target file_data
    ## ‚óè built target file_data [21.084 seconds]
    ## ‚ñ∂ start target abundance
    ## ‚óè built target abundance [0.001 seconds]
    ## ‚ñ∂ start target file_formula
    ## ‚óè built target file_formula [0 seconds]
    ## ‚ñ∂ start target pseudobulk_df_tissue
    ## ‚óè built target pseudobulk_df_tissue [0.016 seconds]
    ## ‚ñ∂ start branch pseudobulk_df_tissue_dispersion_5a2c6e14
    ## Submitted batch job 14937691
    ## ‚ñ∂ start target number_of_workers
    ## ‚óè built target number_of_workers [0.004 seconds]
    ## ‚ñ∂ start target number_of_datasets
    ## ‚óè built target number_of_datasets [0 seconds]
    ## ‚óè built branch pseudobulk_df_tissue_dispersion_5a2c6e14 [0.848 seconds]
    ## ‚óè built pattern pseudobulk_df_tissue_dispersion
    ## ‚ñ∂ start branch pseudobulk_df_tissue_split_by_gene_64917c93
    ## ‚óè built branch pseudobulk_df_tissue_split_by_gene_64917c93 [0.103 seconds]
    ## ‚óè built pattern pseudobulk_df_tissue_split_by_gene
    ## ‚ñ∂ start target pseudobulk_df_tissue_split_by_gene_grouped
    ## ‚óè built target pseudobulk_df_tissue_split_by_gene_grouped [0.076 seconds]
    ## ‚ñ∂ start branch estimates_chunk_fbce870e
    ## ‚óè built branch estimates_chunk_fbce870e [24.346 seconds]
    ## ‚óè built pattern estimates_chunk
    ## ‚ñ∂ end pipeline [1.168 minutes]
    ## Warning messages:
    ## 1: replacing previous import ‚ÄòtidySingleCellExperiment::plot_ly‚Äô by ‚ÄòtidySummarizedExperiment::plot_ly‚Äô when loading ‚ÄòHPCell‚Äô 
    ## 2: replacing previous import ‚ÄòtidySingleCellExperiment::tidy‚Äô by ‚ÄòtidySummarizedExperiment::tidy‚Äô when loading ‚ÄòHPCell‚Äô 
    ## 3: replacing previous import ‚ÄòtidySummarizedExperiment::tidy‚Äô by ‚Äòtidyseurat::tidy‚Äô when loading ‚ÄòHPCell‚Äô 
    ## 4: replacing previous import ‚ÄòtidySummarizedExperiment::plot_ly‚Äô by ‚Äòtidyseurat::plot_ly‚Äô when loading ‚ÄòHPCell‚Äô 
    ## 5: replacing previous import ‚ÄòtidySingleCellExperiment::join_transcripts‚Äô by ‚Äòtidyseurat::join_transcripts‚Äô when loading ‚ÄòHPCell‚Äô 
    ## 6: 2 targets produced warnings. Run targets::tar_meta(fields = warnings, complete_only = TRUE) for the messages.

    ## HPCell says: Start collecting results.

    ## # A SummarizedExperiment-tibble abstraction: 200 √ó 39
    ## # [90mFeatures=25 | Samples=8 | Assays=counts[0m
    ##    .feature        .sample   counts SampleName cell  dex   albut Run   avgLength
    ##    <chr>           <chr>      <int> <fct>      <fct> <fct> <fct> <fct>     <int>
    ##  1 ENSG00000122707 SRR10395‚Ä¶  11225 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  2 ENSG00000104979 SRR10395‚Ä¶    993 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  3 ENSG00000180902 SRR10395‚Ä¶    369 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  4 ENSG00000260359 SRR10395‚Ä¶     28 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  5 ENSG00000159556 SRR10395‚Ä¶     25 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  6 ENSG00000260290 SRR10395‚Ä¶    197 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  7 ENSG00000167291 SRR10395‚Ä¶   2169 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  8 ENSG00000135441 SRR10395‚Ä¶    105 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ##  9 ENSG00000075240 SRR10395‚Ä¶    891 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ## 10 ENSG00000196152 SRR10395‚Ä¶    170 GSM1275862 N613‚Ä¶ untrt untrt SRR1‚Ä¶       126
    ## # ‚Ñπ 190 more rows
    ## # ‚Ñπ 30 more variables: Experiment <fct>, Sample <fct>, BioSample <fct>,
    ## #   bla <chr>, .abundant <lgl>, Dispersion <dbl>, AIC <dbl>, logLik <dbl>,
    ## #   meanExp <dbl>, `(Intercept)` <dbl>, dexuntrt <dbl>,
    ## #   `N052611_cell__(Intercept)__lower` <dbl>,
    ## #   `N061011_cell__(Intercept)__lower` <dbl>,
    ## #   `N080611_cell__(Intercept)__lower` <dbl>, ‚Ä¶

### Many datasets/cell-types

Sometime we do pseudobulk analyses for each cell type. HPCell allows to
scale all those, in a coherent paralleisation to the HPC.

This would be the input dataset

``` r
# A tibble: 22 √ó 3
   cell_type_harmonised data            formula  
   <chr>                <list>          <list>   
 1 b memory             <SmmrzdEx[,35]> <formula>
 2 b naive              <SmmrzdEx[,35]> <formula>
 3 plasma               <SmmrzdEx[,35]> <formula>
 4 ilc                  <SmmrzdEx[,38]> <formula>
 5 cd4 th1              <SmmrzdEx[,37]> <formula>
 6 cd4 th2              <SmmrzdEx[,40]> <formula>
 7 mait                 <SmmrzdEx[,26]> <formula>
 8 cd8 naive            <SmmrzdEx[,28]> <formula>
 9 cd8 tcm              <SmmrzdEx[,36]> <formula>
10 macrophage           <SmmrzdEx[,21]> <formula>
# ‚Ñπ 12 more rows
# ‚Ñπ Use `print(n = ...)` to see more rows
```

And here the call to the `map` version of
`test_differential_abundance_hpc`

``` r
nested_se |>
      mutate(data = map2_test_differential_abundance_hpc(
        data,
        formula ,
        computing_resources = slurm
      ))
```

This is the output

``` r
# A tibble: 22 √ó 3
   cell_type_harmonised data            formula  
   <chr>                <list>          <list>   
 1 b memory             <SmmrzdEx[,35]> <formula>
 2 b naive              <SmmrzdEx[,35]> <formula>
 3 plasma               <SmmrzdEx[,35]> <formula>
 4 ilc                  <SmmrzdEx[,38]> <formula>
 5 cd4 th1              <SmmrzdEx[,37]> <formula>
 6 cd4 th2              <SmmrzdEx[,40]> <formula>
 7 mait                 <SmmrzdEx[,26]> <formula>
 8 cd8 naive            <SmmrzdEx[,28]> <formula>
 9 cd8 tcm              <SmmrzdEx[,36]> <formula>
10 macrophage           <SmmrzdEx[,21]> <formula>
# ‚Ñπ 12 more rows
# ‚Ñπ Use `print(n = ...)` to see more rows
```

## High-performance single-cell preprocessing

Flowchart

<https://app.mural.co/t/covid7029/m/covid7029/1656652076667/c47e104697d76b36b8dee3bd05d8de9d96d99efd?sender=udbe1ea99c9618abb07196978>

### load input data

``` r
# Load input data (can be a list of directories or single directory)
library(Seurat)
library(scRNAseq)
input_data_path =  tempfile(tmpdir = ".") |> paste0(".rds")
HeOrganAtlasData(ensembl=FALSE,location=FALSE)[, 1:400] |>
  as.Seurat(data = NULL) |>
  saveRDS(input_data_path)
```

### Execute Targets workflow and load results

``` r
# Running the pipeline
preprocessed_seurat = run_targets_pipeline(
    input_data = input_data_path,
    tissue = "pbmc",
    filter_empty_droplets = TRUE,
    sample_column = "Tissue"
)
```

    ## Warning: Targets and globals must have unique names. Ignoring global objects
    ## that conflict with target names: sample_column, tissue, filter_empty_droplets.
    ## Warnings like this one are important, but if you must suppress them, you can do
    ## so with Sys.setenv(TAR_WARN = "false").

    ## ‚úî skip target reference_file

    ## ‚úî skip target tissue_file

    ## ‚úî skip target sample_column_file

    ## ‚úî skip target sample_column

    ## ‚úî skip target tissue

    ## ‚úî skip target reference_label_fine

    ## ‚úî skip target read_file

    ## ‚úî skip branch input_read_58a1fafa

    ## ‚úî skip pattern input_read

    ## ‚úî skip target file

    ## ‚úî skip target filtered_file

    ## ‚úî skip target filter_empty_droplets

    ## ‚úî skip branch empty_droplets_tbl_2a87e9d4

    ## ‚úî skip pattern empty_droplets_tbl

    ## ‚úî skip branch cell_cycle_score_tbl_ab819f51

    ## ‚úî skip pattern cell_cycle_score_tbl

    ## ‚úî skip target reference_read

    ## ‚úî skip branch annotation_label_transfer_tbl_ab819f51

    ## ‚úî skip pattern annotation_label_transfer_tbl

    ## ‚úî skip branch alive_identification_tbl_bfea2a3c

    ## ‚úî skip pattern alive_identification_tbl

    ## ‚úî skip branch doublet_identification_tbl_c49acd50

    ## ‚úî skip pattern doublet_identification_tbl

    ## ‚úî skip branch non_batch_variation_removal_S_2405b948

    ## ‚úî skip pattern non_batch_variation_removal_S

    ## ‚úî skip branch preprocessing_output_S_269c823b

    ## ‚úî skip pattern preprocessing_output_S

    ## ‚úî skip target reference_label_coarse

    ## ‚úî skip target pseudobulk_preprocessing_SE

    ## ‚úî skip pipeline [0.237 seconds]

    ## HPCell says: you can read your output executing tar_read(preprocessing_output_S, store = "./")

``` r
# Load results
preprocessed_seurat
```

    ## $preprocessing_output_S_269c823b
    ## # A Seurat-tibble abstraction: 290 √ó 46
    ## # [90mFeatures=9560 | Cells=290 | Active assay=SCT | Assays=originalexp, SCT[0m
    ##    .cell    orig.ident nCount_originalexp nFeature_originalexp Tissue nCount_RNA
    ##    <chr>    <fct>                   <dbl>                <int> <chr>       <int>
    ##  1 Bladder‚Ä¶ Bladder                  1133                  592 Bladd‚Ä¶       1152
    ##  2 Bladder‚Ä¶ Bladder                  3495                 1374 Bladd‚Ä¶       3551
    ##  3 Bladder‚Ä¶ Bladder                  1297                  797 Bladd‚Ä¶       1599
    ##  4 Bladder‚Ä¶ Bladder                  2071                  953 Bladd‚Ä¶       2355
    ##  5 Bladder‚Ä¶ Bladder                  2166                 1102 Bladd‚Ä¶       2474
    ##  6 Bladder‚Ä¶ Bladder                  2486                 1185 Bladd‚Ä¶       2734
    ##  7 Bladder‚Ä¶ Bladder                  3175                 1418 Bladd‚Ä¶       3727
    ##  8 Bladder‚Ä¶ Bladder                  1847                  932 Bladd‚Ä¶       2013
    ##  9 Bladder‚Ä¶ Bladder                  2546                 1104 Bladd‚Ä¶       2649
    ## 10 Bladder‚Ä¶ Bladder                   969                  574 Bladd‚Ä¶       1138
    ## # ‚Ñπ 280 more rows
    ## # ‚Ñπ 40 more variables: nFeature_RNA <int>, percent.mito <dbl>,
    ## #   RNA_snn_res.orig <int>, seurat_clusters <int>,
    ## #   Cell_type_in_each_tissue <chr>, Cell_type_in_merged_data <chr>,
    ## #   reclustered.broad <chr>, reclustered.fine <chr>, Total <int>,
    ## #   LogProb <dbl>, PValue <dbl>, Limited <lgl>, FDR <dbl>, empty_droplet <lgl>,
    ## #   rank <dbl>, total <int>, fitted <dbl>, knee <dbl>, inflection <dbl>, ‚Ä¶

### Include reference dataset for azimuth annotation

Details to come.

``` r
input_reference_path  <- "reference_azimuth.rds" 
reference_url <- "https://atlas.fredhutch.org/data/nygc/multimodal/pbmc_multimodal.h5seurat" 
download.file(reference_url, input_reference_path) 
LoadH5Seurat(input_reference_path) |> saveRDS(input_reference_path)
```
